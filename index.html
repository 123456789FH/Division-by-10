<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ูุฑุงุฌุนุฉ ูุชุนุฒูุฒ ุงููุณูุฉ | ุชุทุจูู ุชูุงุนูู</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">

  <style>
    *{ font-family: 'Tajawal', system-ui, -apple-system, Segoe UI, Arial, sans-serif; }

    /* โ ูุถูุญ ุฃุนูู ูููุต */
    html{ font-size: 18px; }
    @media (max-width: 640px){ html{ font-size: 16.5px; } }

    body{
      background: linear-gradient(180deg,#fff7ed,#ffffff);
      color:#0f172a;               /* ุชุจุงูู ุฃุนูู */
      line-height: 1.9;            /* ุณุทุฑูุฉ ุฃูุถุญ */
      -webkit-font-smoothing: antialiased;
      text-rendering: optimizeLegibility;
      padding-bottom: 84px;        /* ูุณุงุญุฉ ููุชุฐููู ุงูุซุงุจุช */
    }

    .card{ border:1px solid rgba(15,23,42,.10); box-shadow: 0 10px 25px rgba(2,6,23,.06); }
    .pill{ border:1px solid rgba(15,23,42,.14); }
    .hl{ background: #FEF08A; padding: 0 .35rem; border-radius: .35rem; }
    .muted{ color:#334155; }      /* โ ูุงู ูุงุชุญุ ุตุงุฑ ุฃูุถุญ */

    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      border:1px solid rgba(15,23,42,.18); border-bottom-width:2px; border-radius:.5rem; padding:.1rem .4rem; background:#fff;
    }
    .shake{ animation: shake .25s linear 1; }
    @keyframes shake{ 0%{transform:translateX(0)} 25%{transform:translateX(3px)} 50%{transform:translateX(-3px)} 75%{transform:translateX(2px)} 100%{transform:translateX(0)} }

    /* Print */
    @media print{
      .no-print{ display:none !important; }
      #fixedFooter{ display:none !important; } /* ูุง ูุบุทู ุงููุญุชูู ุนูุฏ ุงูุทุจุงุนุฉ */
      body{ background:#fff; padding-bottom: 0; }
      .print-area{ column-count:2; column-gap:1.2rem; }
      .card{ box-shadow:none; }
      input, button, select, textarea{ display:none !important; }
      .print-show-blank{
        display:inline-block !important;
        border-bottom:2px dotted #111827;
        min-width:80px;
        height: 1.1em;
        vertical-align: baseline;
      }
    }
    .print-show-blank{ display:none; }
  </style>
</head>

<body class="min-h-screen">
  <div id="contentRoot" class="max-w-6xl mx-auto p-4 md:p-6">
    <!-- Header -->
    <header class="no-print card rounded-2xl bg-white p-4 md:p-6 flex flex-col gap-4">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
        <div>
          <h1 class="text-2xl md:text-3xl font-extrabold">๐ ูุฑุงุฌุนุฉ ูุชุนุฒูุฒ ุงููุณูุฉ โ ุชุทุจูู ุชูุงุนูู</h1>
          <p class="muted mt-1">ุชุณูุณู: ูุฑุงุฌุนุฉ ุงูุณุงุจู โ ุฃุณุงุณูุงุช โ ุชุฏุฑูุจ ูุชุทุจูู โ ุฅุถุงูุงุช โ ููุงุฑุงุช ุนููุง โ ุงุฎุชุจุงุฑ ุดุงูู (ููุท ูุงูุณ)</p>
        </div>

        <div class="flex flex-wrap items-center gap-2">
          <button id="btnHome" class="pill px-3 py-2 rounded-xl bg-slate-900 text-white hover:opacity-95">
            ๐ ุงูุตูุญุฉ ุงูุฑุฆูุณูุฉ
          </button>

          <button id="btnReset" class="pill px-3 py-2 rounded-xl bg-white hover:bg-slate-50">
            โป๏ธ ุชุตููุฑ ุงูุชูุฏูู
          </button>

          <button id="btnPrintStudent" class="pill px-3 py-2 rounded-xl bg-white hover:bg-slate-50">
            ๐จ๏ธ ุทุจุงุนุฉ ูุณุฎุฉ ุงูุทุงูุจ
          </button>
          <button id="btnPrintTeacher" class="pill px-3 py-2 rounded-xl bg-white hover:bg-slate-50">
            ๐จ๏ธ ุทุจุงุนุฉ ูุณุฎุฉ ุงููุนูู
          </button>

          <div class="flex items-center gap-2 pill px-3 py-2 rounded-xl bg-amber-50">
            <span class="text-sm font-bold">ุงููุถุน</span>
            <button id="toggleMode" class="pill px-3 py-1.5 rounded-lg bg-white hover:bg-amber-100 text-sm font-bold">
              ุทุงูุจ
            </button>
          </div>
        </div>
      </div>

      <!-- Progress -->
      <div class="grid md:grid-cols-3 gap-3">
        <div class="card rounded-2xl p-4 bg-slate-50">
          <div class="text-sm muted">ูุณุชูู ุงูุฅุชูุงู ุงูุนุงู</div>
          <div class="flex items-baseline gap-2 mt-1">
            <div id="overallPct" class="text-3xl font-extrabold">ููช</div>
            <div class="muted text-sm">ูู ุงูุฃุณุฆูุฉ ุงููููููุฉ</div>
          </div>
          <div class="mt-3 h-2 rounded-full bg-slate-200 overflow-hidden">
            <div id="overallBar" class="h-full bg-slate-900 w-0"></div>
          </div>
          <div class="muted text-xs mt-2">ูุตูุญุฉ: ุฅุฐุง ูุฒูุช ุนู ูงููช ุงุฑุฌุน ูููุงุฑุฉ โุงูุญูุงุฆู ุงููุชุฑุงุจุทุฉโ ูุจู ุงูุฅููุงู.</div>
        </div>

        <div class="card rounded-2xl p-4 bg-white">
          <div class="text-sm muted">ุชูุจูู ุชุฑุจูู ุณุฑูุน</div>
          <p class="mt-2 text-sm leading-7">
            ุนูุฏ ุฃู ุฎุทุฃ ูุชูุฑุฑ: <span class="hl font-bold">ุงุฑุฌุน ููุฃุณุงุณ</span> (ุญูุงุฆู ูุชุฑุงุจุทุฉ/ุนุฏู ุจุงูุนุดุฑุงุช/ููุงุนุฏ ุงูุตูุฑ ูุงููุงุญุฏ)ุ ุซู ุฌุฑูุจ ูุฑุฉ ุฃุฎุฑู.
          </p>
          <div class="mt-3 text-xs muted">
            ุงุฎุชุตุงุฑุงุช: <span class="kbd">ุชุญูู</span> ูุชุตุญูุญ ุงูุฅุฌุงุจุฉ โ <span class="kbd">ุฅุธูุงุฑ</span> ูุนุฑุถ ุงูุญู (ูู ูุถุน ุงููุนูู).
          </div>
        </div>

        <div class="card rounded-2xl p-4 bg-white">
          <div class="text-sm muted">ููุชุงุญ ุงูุชุธููู</div>
          <p class="mt-2 text-sm leading-7">
            ุฃู ูุงุนุฏุฉ ุฃู ุฌุฒุก ููู ูุธูุฑ ุจุชุธููู <span class="hl font-bold">ุฃุตูุฑ</span> ูุซู ุงููุชุงุจ.
          </p>
          <p class="mt-2 text-xs muted">
            ูู ุงูุทุจุงุนุฉ: ุชูุทุจุน โูุฑุงุบุงุชโ ุจุฏู ุญููู ุงูุฅุฏุฎุงู ุชููุงุฆููุง.
          </p>
        </div>
      </div>
    </header>

    <!-- Main -->
    <main id="app" class="mt-4 md:mt-6"></main>

    <!-- Footer (ุขุฎุฑ ุงูุตูุญุฉ + ุงูุทุจุงุนุฉ) -->
    <footer class="mt-8 card rounded-2xl bg-white p-4 text-center">
      <div class="text-sm font-bold">ููุชูู ูุนููู ููุนููุงุช ุงูุฑูุงุถูุงุช | ุงูููุชูู ุงูุชูุงุนูู</div>
      <div class="text-xs muted mt-1">ุฃ/ ูุงุทูุฉ ูุฒุงุฒู</div>
      <div class="text-xs muted mt-2">ยฉ <span id="year"></span></div>
    </footer>
  </div>

  <!-- โ ุชุฐููู ุซุงุจุช -->
  <div id="fixedFooter" class="fixed bottom-0 left-0 right-0 z-50 bg-white/95 backdrop-blur border-t border-slate-200">
    <div class="max-w-6xl mx-auto px-4 py-2 text-center text-sm font-extrabold text-slate-800">
      ุฃ/ ูุงุทูุฉ ูุฒุงุฒู
    </div>
  </div>

<script>
/* =========================
   โ Arabic Digits Support
   - ุนุฑุถ ุงูุฃุฑูุงู ุนุฑุจูุฉ
   - ูุจูู ุฅุฏุฎุงู ุนุฑุจู/ุฅูุฌููุฒู
========================= */
const AR_NUM = { "0":"ู","1":"ูก","2":"ูข","3":"ูฃ","4":"ูค","5":"ูฅ","6":"ูฆ","7":"ูง","8":"ูจ","9":"ูฉ" };
const TO_WEST = {
  "ู":"0","ูก":"1","ูข":"2","ูฃ":"3","ูค":"4","ูฅ":"5","ูฆ":"6","ูง":"7","ูจ":"8","ูฉ":"9",
  "ฐ":"0","ฑ":"1","ฒ":"2","ณ":"3","ด":"4","ต":"5","ถ":"6","ท":"7","ธ":"8","น":"9"
};

function toArabicDigits(x){
  return String(x).replace(/[0-9]/g, d => AR_NUM[d]);
}
function toWesternDigits(x){
  return String(x).replace(/[ู-ูฉฐ-น]/g, ch => TO_WEST[ch] ?? ch);
}
function fmtPercent(n){
  return toArabicDigits(String(n)) + "ูช";
}
function arabizeDigitsInTextNodes(root){
  if(!root) return;
  const walker = document.createTreeWalker(root, NodeFilter.SHOW_TEXT, {
    acceptNode(node){
      const v = node.nodeValue;
      if(!v || !/[0-9]/.test(v)) return NodeFilter.FILTER_REJECT;
      const p = node.parentElement;
      if(!p) return NodeFilter.FILTER_REJECT;
      const tag = p.tagName;
      if(tag === "SCRIPT" || tag === "STYLE" || tag === "CODE" || tag === "PRE") return NodeFilter.FILTER_REJECT;
      return NodeFilter.FILTER_ACCEPT;
    }
  });
  let n;
  while((n = walker.nextNode())){
    n.nodeValue = toArabicDigits(n.nodeValue);
  }
}

/* =========================
   Data + State
========================= */
const APP_KEY = "division_skill_app_v1";
const state = {
  mode: "student",            // student | teacher
  route: "home",              // home | module:<id>
  progress: {},               // { qid: {attempted:true, correct:true/false, ts:number} }
  dynamicQuestions: {}        // per generator / solved toggles
};

const modules = [
  {
    id: "diag",
    title: "ุงุณุชุฏุนุงุก ุณุฑูุน ููุง ุณุจู (ุชุดุฎูุต)",
    icon: "๐งญ",
    goal: "ุชุญุฏุฏ ูุณุชูู ุงูุฃุณุงุณ ุฎูุงู ุฏูููุฉ ูุจู ุงูุงูุชูุงู.",
    feedback: [
      "ุฅุฐุง ุฃุฎุทุฃุช ูู ุงูุญูุงุฆู ุงููุชุฑุงุจุทุฉ: ุงุฑุฌุน ูููุงุฑุฉ (Fact Family) ูุจู ุงูุฅููุงู.",
      "ุฅุฐุง ุฃุฎุทุฃุช ูู ุงููุณูุฉ ุนูู 10: ุฑุงุฌุน ุงูุนุฏู ุจุงูุนุดุฑุงุช.",
      "ุฅุฐุง ุฃุฎุทุฃุช ูู ูุณูุฉ ุงูุตูุฑ/ุนูู ุงููุงุญุฏ: ุซุจูุช ุงูููุงุนุฏ ุงูุฃุฑุจุน."
    ],
    blocks: [
      noteBlock("ุงูููุฑุฉ", `ุงุจุฏุฃ ุจูุฐู ุงูุฃุณุฆูุฉ ูุชุนุฑู: ูู ุชุญุชุงุฌ ุชุนุฒูุฒ ููุงุฑุฉ ููููุฏุฉ ุฃู ุฃูุช ุฌุงูุฒ ููููุงุฑุฉ ุงูุญุงููุฉุ`),
      quizBlock("ุฃุณุฆูุฉ ุชุดุฎูุตูุฉ", [
        qInput("diag_1", `ุงุญุณุจ: <span class="hl">30 รท 10</span> =`, "3", "ุชุฐููุฑ: ูู ุนุดุฑุฉ ูู 30ุ"),
        qInput("diag_2", `ุงุญุณุจ: <span class="hl">45 รท 5</span> =`, "9", "ุงุณุชุฎุฏู ุงูุญูุงุฆู ุงููุชุฑุงุจุทุฉ: 5ร9=45."),
        qInput("diag_3", `ุฃููู: <span class="hl">6 ร 9 = 54</span> ุฅุฐู <span class="hl">54 รท 6</span> =`, "9", "ุฅุฐุง aรb=c ุฅุฐู cรทa=b."),
        qInput("diag_4", `ุงุญุณุจ: <span class="hl">8 ร 10</span> =`, "80", "ูุถุงุนูุงุช 10 ุชูุชูู ุจุตูุฑ."),
        qInput("diag_5", `ุงุญุณุจ: <span class="hl">0 รท 7</span> =`, "0", "ูุงุนุฏุฉ: 0 รท ุนุฏุฏ = 0 (ูุง ุฏุงู ุงูุนุฏุฏ ููุณ 0).")
      ]),
      tipBlock("ุชุบุฐูุฉ ุฑุงุฌุนุฉ ููุฑูุฉ", `
        โ ุฅุฐุง ุญุตูุช ุนูู <span class="hl font-bold">4/5 ุฃู 5/5</span> ุงูุชูู ูุจุงุดุฑุฉ ููููุงุฑุฉ ุงูุญุงููุฉ.<br>
        โ ุฅุฐุง ุญุตูุช ุนูู ุฃูู ูู ุฐูู: ุฑููุฒ ุฃูููุง ุนูู ุงูููุงุฑุฉ ุงูุชู ุฃุฎุทุฃุช ูููุงุ ุซู ุฃุนุฏ ุงููุญุงููุฉ.
      `)
    ]
  },

  {
    id: "factfamily",
    title: "ุงูููุงุฑุฉ ุงูุณุงุจูุฉ: ุงูุญูุงุฆู ุงููุชุฑุงุจุทุฉ (Fact Family)",
    icon: "๐",
    goal: "ุชุฑุจุท ุงูุถุฑุจ ุจุงููุณูุฉ ูุชุตู ูููุงุชุฌ ุจุณุฑุนุฉ ูุซูุฉ.",
    feedback: [
      "ุฅุฐุง ุฎูุทุช ุจูู ุงูููุณูู ูุงูููุณูู ุนููู: ุชุฐููุฑ ุฃู ุงูููุณูู ุบุงูุจูุง ูู ุงูุนุฏุฏ ุงูุฃูุจุฑ ููุง.",
      "ุฅุฐุง ูุชุจุช ุฃูู ูู 4 ุฌูู: ุฃููู (ุฌููุชูู ุถุฑุจ + ุฌููุชูู ูุณูุฉ).",
      "ุฅุฐุง ุชูุฑุฑุช ุงูุฃุฎุทุงุก: ุฑุงุฌุน ุฌุฏูู ุงูุถุฑุจ ุงููุฑุชุจุท ูุจู ุงูุนูุฏุฉ ูููุณูุฉ."
    ],
    blocks: [
      noteBlock("ุงูุฃุณุงุณูุงุช", `
        ุฅุฐุง ูุงูุช <span class="hl">a ร b = c</span> ูููุงู 4 ุฌูู ูุชุฑุงุจุทุฉ:
        <div class="mt-2 leading-8">
          โข a ร b = c<br>
          โข b ร a = c<br>
          โข c รท a = b<br>
          โข c รท b = a
        </div>
      `),
      solvedBlock("ูุซุงู ูุญููู (ูุธูู)", [
        `ุฅุฐุง ูุงูุช <span class="hl font-bold">6 ร 9 = 54</span>`,
        `ุฅุฐู <span class="hl font-bold">54 รท 6 = 9</span>`,
        `ู <span class="hl font-bold">54 รท 9 = 6</span>`
      ], "factfamily_solved_1"),
      quizBlock("ุชุฏุฑูุจ (ุงูุชุจ ุงููุงุชุฌ)", [
        qInput("ff_1", `ุงุญุณุจ: <span class="hl">50 รท 10</span> =`, "5", "ูุฃู 10ร5=50."),
        qInput("ff_2", `ุงุญุณุจ: <span class="hl">56 รท 7</span> =`, "8", "ูุฃู 7ร8=56."),
        qInput("ff_3", `ุงุญุณุจ: <span class="hl">56 รท 8</span> =`, "7", "ูุฃู 8ร7=56."),
        qInput("ff_4", `ุฃููู: ุฅุฐุง <span class="hl">9 ร 10 = 90</span> ุฅุฐู <span class="hl">90 รท 9</span> =`, "10", "cรทa=b."),
        qInput("ff_5", `ุฃููู: ุฅุฐุง <span class="hl">5 ร 10 = 50</span> ุฅุฐู <span class="hl">50 รท 5</span> =`, "10", "ุญูุงุฆู ูุชุฑุงุจุทุฉ.")
      ]),
      openBlock("ููุงุฑุงุช ุนููุง", [
        "ุงุดุฑุญ: ููุงุฐุง ูุง ูููู ูุชุงุจุฉ ุฃูุซุฑ ูู 4 ุฌูู ูุชุฑุงุจุทุฉ ููุฌููุนุฉ (4ุ6ุ24)ุ",
        "ูููู ูุฌููุนุฉ ุญูุงุฆู ูุชุฑุงุจุทุฉ ูู ุงุฎุชูุงุฑูุ ุซู ุงูุชุจ ุงูุฌูู ุงูุฃุฑุจุน."
      ], "ff_open_1"),
      tipBlock("ุชุบุฐูุฉ ุฑุงุฌุนุฉ ููููุงุฑุฉ", `
        โ ุฅุฐุง ุฃุฌุจุช ุจุฏูู ุชุฑุฏุฏ: ููุชุงุฒ โ ุงูุชูู ูููุณูุฉ ุนูู 10.<br>
        โ ุฅุฐุง ุชูููุช ูุซูุฑูุง: ุฑุงุฌุน ุฌุฏูู ุงูุถุฑุจ ุงููุฑุชุจุทุ ุซู ุฃุนุฏ ุญู ููุณ ุงูุฃุณุฆูุฉ.
      `)
    ]
  },

  {
    id: "div5",
    title: "ุงูููุงุฑุฉ ุงูุณุงุจูุฉ: ุงููุณูุฉ ุนูู 5",
    icon: "๐งฉ",
    goal: "ุชุซุจุช ููุท ุงููุณูุฉ ุนูู 5 ูุจู ุงูุงูุชูุงู ูููุท 10.",
    feedback: [
      "ุฅุฐุง ูุณูุช ุฌุฏูู 5: ุงูุชุจ 5ร1 ุฅูู 5ร10 ุซู ุงุฑุฌุน ูููุณูุฉ.",
      "ุฅุฐุง ุฃุฎุทุฃุช ูู 35รท5 ุฃู 45รท5: ุฑุงุฌุน ูุถุงุนูุงุช 5 ุจุงูุนุฏ (5ุ10ุ15...)."
    ],
    blocks: [
      noteBlock("ุชุฐููุฑ", `ุงููุณูุฉ ุนูู 5 ุชุฑุชุจุท ุจูุถุงุนูุงุช 5. ุงุณุชุฎุฏู ุงูุญูุงุฆู ุงููุชุฑุงุจุทุฉ ูููุตูู ูููุงุชุฌ ุจุณุฑุนุฉ.`),
      solvedBlock("ูุซุงู ูุญููู (ูุธูู)", [
        `<span class="hl font-bold">45 รท 5 = ุ</span>`,
        `ููุฑ: <span class="hl">5 ร 9 = 45</span>`,
        `ุฅุฐู <span class="hl font-bold">45 รท 5 = 9</span>`
      ], "div5_solved_1"),
      quizBlock("ุชุฏุฑูุจ", [
        qInput("d5_1", `ุงุญุณุจ: <span class="hl">25 รท 5</span> =`, "5", "5ร5=25."),
        qInput("d5_2", `ุงุญุณุจ: <span class="hl">50 รท 5</span> =`, "10", "5ร10=50."),
        qInput("d5_3", `ุงุญุณุจ: <span class="hl">40 รท 5</span> =`, "8", "5ร8=40."),
        qInput("d5_4", `ุงุญุณุจ: <span class="hl">35 รท 5</span> =`, "7", "5ร7=35.")
      ]),
      tipBlock("ุชุบุฐูุฉ ุฑุงุฌุนุฉ ููููุงุฑุฉ", `
        โ ุฅุฐุง ูุตูุช ูููุงุชุฌ ุนุจุฑ ุงูุญูุงุฆู ุงููุชุฑุงุจุทุฉ: ุฃูุช ุฌุงูุฒ ูููุณูุฉ ุนูู 10.<br>
        โ ุฅุฐุง ูุงู ุญููู ุจุงูุชุฎููู: ุงุฑุฌุน ููุญูููุฉ (5รุ=ุงูุนุฏุฏ) ุซู ุงุญุณุจ.
      `)
    ]
  },

  {
    id: "div10",
    title: "ุงูููุงุฑุฉ ุงูุญุงููุฉ: ุงููุณูุฉ ุนูู 10",
    icon: "๐ฏ",
    goal: "ุชุชูู ุงููุณูุฉ ุนูู 10 ุนุจุฑ ุงูุนุฏ ุจุงูุนุดุฑุงุช ูุงูุญูุงุฆู ุงููุชุฑุงุจุทุฉ.",
    feedback: [
      "ุฅุฐุง ูุชุจุช ุงููุงุชุฌ ูุซู ุงูุนุฏุฏ ุงูุฃุตูู: ุชุฐููุฑ ุฃู ุงููุณูุฉ ุนูู 10 ุชููููู ุงูุนุฏุฏ.",
      "ุฅุฐุง ุฎูุทุช ุงูุตูุฑ: ุงุณุฃู ููุณู: ูู ุนุดุฑุฉ ูู ุงูุนุฏุฏุ",
      "ุฅุฐุง ุฃุฎุทุฃุช ูู 100รท10: ุซุจูุช ููููู (10 ุนุดุฑุงุช = 100)."
    ],
    blocks: [
      noteBlock("ุงูุฃุณุงุณูุงุช (ููุง ูู ุงููุชุงุจ)", `
        ุทุฑููุชุงู ุฐูุจูุชุงู:
        <div class="mt-2 leading-8">
          โข <span class="hl font-bold">ุงูุนุฏ ุจุงูุนุดุฑุงุช</span>: ูู ุนุดุฑุฉ ูู ุงูุนุฏุฏุ<br>
          โข <span class="hl font-bold">ุงูุญูุงุฆู ุงููุชุฑุงุจุทุฉ</span>: ุฅุฐุง 10รู = ุงูุนุฏุฏ ุฅุฐู ุงูุนุฏุฏรท10 = ู
        </div>
      `),
      solvedBlock("ูุซุงู 1 (ุนุฏู ุนุดุฑุงุช)", [
        `<span class="hl font-bold">80 รท 10</span>`,
        `80 ูููุง <span class="hl">8 ุนุดุฑุงุช</span>`,
        `ุฅุฐู ุงููุงุชุฌ <span class="hl font-bold">8</span>`
      ], "div10_solved_1"),
      solvedBlock("ูุซุงู 2 (ุญูุงุฆู ูุชุฑุงุจุทุฉ)", [
        `<span class="hl font-bold">50 รท 10</span>`,
        `ูุฃู <span class="hl">10 ร 5 = 50</span>`,
        `ุฅุฐู <span class="hl font-bold">50 รท 10 = 5</span>`
      ], "div10_solved_2"),
      quizBlock("ุชุฏุฑูุจ (ุชุทุจูู ุงููุงููู)", [
        qInput("d10_1", `ุงุญุณุจ: <span class="hl">20 รท 10</span> =`, "2", "ูู ุนุดุฑุฉ ูู 20ุ"),
        qInput("d10_2", `ุงุญุณุจ: <span class="hl">40 รท 10</span> =`, "4", "ูู ุนุดุฑุฉ ูู 40ุ"),
        qInput("d10_3", `ุงุญุณุจ: <span class="hl">60 รท 10</span> =`, "6", "ูู ุนุดุฑุฉ ูู 60ุ"),
        qInput("d10_4", `ุงุญุณุจ: <span class="hl">70 รท 10</span> =`, "7", "ูู ุนุดุฑุฉ ูู 70ุ"),
        qInput("d10_5", `ุงุญุณุจ: <span class="hl">90 รท 10</span> =`, "9", "ูู ุนุดุฑุฉ ูู 90ุ"),
        qInput("d10_6", `ุงุญุณุจ: <span class="hl">100 รท 10</span> =`, "10", "100 ูููุง 10 ุนุดุฑุงุช.")
      ]),
      quizBlock("ุชุฏุฑูุจ (ุงุฎุชูุงุฑ ูู ูุชุนุฏุฏ โ ููุท ูุงูุณ)", [
        qMCQ("d10_mcq_1", `ูุงุชุฌ <span class="hl">90 รท 10</span> ูุณุงูู:`, ["9","10","90","0"], 0, "ูุงุนุฏุฉ: ุงูุนุฏุฏ รท 10 = ุนุฏุฏ ุงูุนุดุฑุงุช."),
        qMCQ("d10_mcq_2", `ุฅุฐุง ูุงู <span class="hl">9 = 90 รท โก</span> ูุฅู โก ูุณุงูู:`, ["1","10","81","100"], 1, "ูุฃู 90 รท 10 = 9.")
      ]),
      openBlock("ููุงุฑุงุช ุนููุง", [
        "ุงูุชุจ ุทุฑููุชูู ูุญู 50 รท 10 (ุนุฏ ุนุดุฑุงุช / ุญูุงุฆู ูุชุฑุงุจุทุฉ).",
        "ูููู ุนุฏุฏูู ูู ุฑูููู ููุชููุงู ุจุตูุฑุ ุซู ุงูุชุจ ูุณูุฉ ูู ุนุฏุฏ ุนูู 10."
      ], "div10_open_1"),
      generatorBlock("ูููุฏ ุชูุงุฑูู ุฅุถุงููุฉ (ููุชุฃููุฏ)", "div10_gen", [
        { label:"ุงุฎุชุฑ ุงูุนุฏุฏ", type:"select", key:"base", options:["20","30","40","50","60","70","80","90","100"] },
        { label:"ุนุฏุฏ ุงูุฃุณุฆูุฉ", type:"number", key:"count", min: 3, max: 15, value: 6 }
      ], (cfg) => genDivisionBy10(cfg.base, cfg.count)),
      tipBlock("ุชุบุฐูุฉ ุฑุงุฌุนุฉ ููููุงุฑุฉ", `
        โ ุฅุฐุง ููุช ุชุญู ุจุณุฑุนุฉ ุนุจุฑ โูู ุนุดุฑุฉุโ: ููุชุงุฒ.<br>
        โ ุฅุฐุง ุชุชูุฑุฑ ุฃุฎุทุงุคู: ุงูุชุจ ูุถุงุนูุงุช 10 ุญุชู 100 ุซู ุฃุนุฏ ุงูุญู.
      `)
    ]
  },

  {
    id: "zeroone",
    title: "ุงูููุงุฑุฉ ุงูุญุงููุฉ: ุงููุณูุฉ ูุน ุงูุตูุฑ ูุนูู ุงููุงุญุฏ",
    icon: "๐ง",
    goal: "ุชุซุจุช ููุงุนุฏ ุงูุตูุฑ ูุงููุงุญุฏ ูุชุณุชุฎุฏููุง ูู ุงูุงุฎุชุจุงุฑุงุช.",
    feedback: [
      "ุฅุฐุง ุธููุช ุฃู aรทa=a: ุชุฐููุฑ ุฃู ุงููุงุชุฌ 1 (ูุง ุฏุงู aโ0).",
      "ุฅุฐุง ูุจูุช ุงููุณูุฉ ุนูู ุงูุตูุฑ: ูุฐุง ุบูุฑ ูููู ุฏุงุฆููุง.",
      "ุฅุฐุง ุฎูุทุช 0รทa: ูุงุนุฏุฉ ุซุงุจุชุฉ = 0."
    ],
    blocks: [
      noteBlock("ุงูููุงุนุฏ ุงูุฃุฑุจุน (ูุธููุฉ)", `
        <div class="leading-9">
          1) <span class="hl font-bold">a รท a = 1</span> (ุฅุฐุง ูุงู a โ 0)<br>
          2) <span class="hl font-bold">a รท 1 = a</span><br>
          3) <span class="hl font-bold">0 รท a = 0</span> (ุฅุฐุง ูุงู a โ 0)<br>
          4) <span class="hl font-bold">ูุง ูููู ุงููุณูุฉ ุนูู 0</span>
        </div>
      `),
      solvedBlock("ุฃูุซูุฉ ูุญูููุฉ (ูุธููุฉ)", [
        `<span class="hl">7 รท 7 = 1</span>`,
        `<span class="hl">9 รท 1 = 9</span>`,
        `<span class="hl">0 รท 7 = 0</span>`,
        `<span class="hl">7 รท 0</span> ุบูุฑ ูููู`
      ], "zeroone_solved_1"),
      quizBlock("ุชุฏุฑูุจ (ุตุญ/ุฎุทุฃ)", [
        qTF("zo_tf_1", `ุนุจุงุฑุฉ: <span class="hl">6 รท 6 = 6</span>`, false, "ุงูุตุญูุญ: 6รท6=1."),
        qTF("zo_tf_2", `ุนุจุงุฑุฉ: <span class="hl">9 รท 1 = 9</span>`, true, "ูุงุนุฏุฉ: aรท1=a."),
        qTF("zo_tf_3", `ุนุจุงุฑุฉ: <span class="hl">0 รท 5 = 0</span>`, true, "ูุงุนุฏุฉ: 0รทุนุฏุฏ=0."),
        qTF("zo_tf_4", `ุนุจุงุฑุฉ: <span class="hl">5 รท 0 = 0</span>`, false, "ูุง ูููู ุงููุณูุฉ ุนูู 0.")
      ]),
      quizBlock("ุชุฏุฑูุจ (ุฃุฏุฎู ุงููุงุชุฌ)", [
        qInput("zo_1", `ุงุญุณุจ: <span class="hl">8 รท 8</span> =`, "1", "aรทa=1 (ุฅุฐุง aโ0)."),
        qInput("zo_2", `ุงุญุณุจ: <span class="hl">12 รท 1</span> =`, "12", "aรท1=a."),
        qInput("zo_3", `ุงุญุณุจ: <span class="hl">0 รท 9</span> =`, "0", "0รทa=0.")
      ]),
      openBlock("ููุงุฑุงุช ุนููุง", [
        "ุงุดุฑุญ: ููุงุฐุง 0 รท 7 = 0 ุจุงุณุชุฎุฏุงู ูุนูู ุงููุณูุฉ ูุชูุฒูุนุ",
        "ุงูุชุจ ูุณุฃูุฉ ูู ูุงูุน ุงูุญูุงุฉ ุชูุซู: ุนุฏุฏ รท ุนุฏุฏ = 1."
      ], "zo_open_1"),
      tipBlock("ุชุบุฐูุฉ ุฑุงุฌุนุฉ ููููุงุฑุฉ", `
        โ ุฅุฐุง ุทุจููุช ุงูููุงุนุฏ ูุจุงุดุฑุฉ: ููุชุงุฒ โ ุฃูุช ุฌุงูุฒ ููุงุฎุชุจุงุฑ ุงูุดุงูู.<br>
        โ ุฅุฐุง ุฃุฎุทุฃุช ูู ูุงุนุฏุฉ ูุงุญุฏุฉ: ุงูุชุจ ุงูููุงุนุฏ ุงูุฃุฑุจุน ุซู ุญู 5 ุฃูุซูุฉ ุณุฑูุนุฉ.
      `)
    ]
  },

  {
    id: "nafes",
    title: "ุงุฎุชุจุงุฑ ูุชูููู ุดุงูู (ููุท ูุงูุณ)",
    icon: "๐",
    goal: "ุชููุณ ุงูุฅุชูุงู: ุชุทุจูู ูุจุงุดุฑ + ููุงุฑุงุช ุนููุง + ุงุฎุชูุงุฑ ูู ูุชุนุฏุฏ ุจูุดุชุชุงุช.",
    feedback: [
      "ุฅุฐุง ุฃุฎุทุฃุช ูู ุณุคุงููู ุฃู ุฃูุซุฑ ูู ููุณ ุงูููุงุฑุฉ: ุนุฏ ูููุฑุงุฌุนุฉ ุงูุฎุงุตุฉ ุจูุง ุซู ุฃุนุฏ ุงูุงุฎุชุจุงุฑ.",
      "ุฅุฐุง ูุงูุช ุฃุฎุทุงุคู ูู ุงููุดุชุชุงุช: ุงูุฑุฃ ุงูุณุคุงู ุจุจุทุก ูุญุฏุฏ ุงููููุฉ ุงูููุชุงุญูุฉ (รท10 / รท1 / 0รท...)."
    ],
    blocks: [
      noteBlock("ุชุนูููุงุช ุงูุงุฎุชุจุงุฑ", `
        ุฃุฌุจ ุจูุฏูุก. ุจุนุฏ ุงูุงูุชูุงุก ุงุถุบุท <span class="kbd">ุชุญูู</span> ููู ุณุคุงู. ูู ูุถุน ุงูุทุงูุจ ูู ุชุธูุฑ ุงูุฅุฌุงุจุงุช ุฅูุง ุจุนุฏ ุงููุญุงููุฉ.
      `),
      quizBlock("ุฃุณุฆูุฉ ูุตูุฑุฉ (10)", [
        qInput("nf_1", `ุงุญุณุจ: <span class="hl">60 รท 10</span> =`, "6", "ูู ุนุดุฑุฉ ูู 60ุ"),
        qInput("nf_2", `ุงุญุณุจ: <span class="hl">30 รท 10</span> =`, "3", "ูู ุนุดุฑุฉ ูู 30ุ"),
        qInput("nf_3", `ุงุญุณุจ: <span class="hl">0 รท 9</span> =`, "0", "0รทุนุฏุฏ=0."),
        qInput("nf_4", `ุงุญุณุจ: <span class="hl">9 รท 1</span> =`, "9", "aรท1=a."),
        qInput("nf_5", `ุงุญุณุจ: <span class="hl">8 รท 8</span> =`, "1", "aรทa=1."),
        qMCQ("nf_6", `ูุงุชุฌ <span class="hl">100 รท 10</span> ูุณุงูู:`, ["1","10","100","0"], 1, "100 ูููุง 10 ุนุดุฑุงุช."),
        qMCQ("nf_7", `ุฃู ุนุจุงุฑุฉ ุตุญูุญุฉุ`, ["7 รท 0 = 7","0 รท 7 = 0","6 รท 6 = 6","9 รท 1 = 1"], 1, "0รทุนุฏุฏ=0."),
        qMCQ("nf_8", `ุฅุฐุง ูุงู <span class="hl">10 ร 6 = 60</span> ูุฅู <span class="hl">60 รท 10</span> =`, ["10","6","60","0"], 1, "ุญูุงุฆู ูุชุฑุงุจุทุฉ."),
        qTF("nf_9", `ุนุจุงุฑุฉ: <span class="hl">0 รท 7 = 7</span>`, false, "ุงูุตุญูุญ: 0รท7=0."),
        qTF("nf_10", `ุนุจุงุฑุฉ: <span class="hl">7 รท 7 = 1</span>`, true, "ูุงุนุฏุฉ: aรทa=1 (ุฅุฐุง aโ0).")
      ]),
      openBlock("ููุงุฑุงุช ุนููุง (ููุงุณ)", [
        "ุงูุชุจ ุทุฑููุชูู ูุญู 80 รท 10.",
        "ูุณูุฑ: ููุงุฐุง ูุง ูููู ุงููุณูุฉ ุนูู 0ุ"
      ], "nf_open_1"),
      tipBlock("ูุชูุฌุฉ ูุชูุฌูู", `
        โ ุฅุฐุง ุญุตูุช ุนูู <span class="hl font-bold">80% ูุฃุนูู</span>: ููุชุงุฒ โ ุซุจูุช ุงูููุงุฑุฉ ุจุชูุงุฑูู ูููุฏุฉ ุฅุถุงููุฉ.<br>
        โ ุฅุฐุง ููุช ุฃูู ูู 80%: ุนุฏ ูููุงุฑุฉ ุงูุฃุฎุทุงุก ุซู ุฃุนุฏ ุงูุงุฎุชุจุงุฑ.
      `)
    ]
  }
];

/* =========================
   Block Builders
========================= */
function noteBlock(title, html){ return { type:"note", title, html }; }
function tipBlock(title, html){ return { type:"tip", title, html }; }
function solvedBlock(title, steps, key){ return { type:"solved", title, steps, key }; }
function openBlock(title, prompts, key){ return { type:"open", title, prompts, key }; }
function quizBlock(title, questions){ return { type:"quiz", title, questions }; }
function generatorBlock(title, key, fields, onGenerate){ return { type:"generator", title, key, fields, onGenerate }; }

/* =========================
   Question Builders
========================= */
function qInput(id, promptHtml, answer, hint){
  return { id, type:"input", promptHtml, answer: String(answer).trim(), hint: hint || "" };
}
function qMCQ(id, promptHtml, choices, correctIndex, hint){
  return { id, type:"mcq", promptHtml, choices, correctIndex, hint: hint || "" };
}
function qTF(id, promptHtml, correctBool, hint){
  return { id, type:"tf", promptHtml, correctBool: !!correctBool, hint: hint || "" };
}

/* =========================
   Generator
========================= */
function genDivisionBy10(base, count){
  const n = Number(toWesternDigits(base));
  let c = parseInt(toWesternDigits(count), 10);
  if(!Number.isFinite(c)) c = 6;
  c = Math.max(3, Math.min(15, c));

  const out = [];
  const baseId = `gen_d10_${n}_${Date.now()}`;
  for(let i=0;i<c;i++){
    const id = `${baseId}_${i+1}`;
    out.push(qInput(id, `ุงุญุณุจ: <span class="hl">${n} รท 10</span> =`, String(n/10), "ุชุฐููุฑ: ูู ุนุดุฑุฉ ูู ุงูุนุฏุฏุ"));
  }
  return out;
}

/* =========================
   Storage
========================= */
function load(){
  try{
    const raw = localStorage.getItem(APP_KEY);
    if(!raw) return;
    const data = JSON.parse(raw);
    if(data && typeof data === "object"){
      Object.assign(state, data);
    }
  }catch(e){}
}
function save(){
  localStorage.setItem(APP_KEY, JSON.stringify({
    mode: state.mode,
    route: state.route,
    progress: state.progress,
    dynamicQuestions: state.dynamicQuestions
  }));
}

/* =========================
   Helpers
========================= */
function setProgress(qid, correct){
  state.progress[qid] = { attempted:true, correct: !!correct, ts: Date.now() };
  save();
  updateOverall();
}
function getProgress(qid){
  return state.progress[qid] || { attempted:false, correct:false };
}
function normalizeAnswer(s){
  return toWesternDigits(String(s ?? "")).replace(/\s+/g,"").trim();
}
function computeOverall(){
  const entries = Object.values(state.progress).filter(x => x.attempted);
  if(entries.length === 0) return { pct: 0, total: 0, correct: 0 };
  const correct = entries.filter(x => x.correct).length;
  const pct = Math.round((correct / entries.length) * 100);
  return { pct, total: entries.length, correct };
}

/* =========================
   Rendering
========================= */
const app = document.getElementById("app");
const overallPct = document.getElementById("overallPct");
const overallBar = document.getElementById("overallBar");
const toggleModeBtn = document.getElementById("toggleMode");
const btnHome = document.getElementById("btnHome");
const btnReset = document.getElementById("btnReset");
const btnPrintStudent = document.getElementById("btnPrintStudent");
const btnPrintTeacher = document.getElementById("btnPrintTeacher");
const yearEl = document.getElementById("year");

yearEl.textContent = toArabicDigits(new Date().getFullYear());

function updateOverall(){
  const { pct } = computeOverall();
  overallPct.textContent = fmtPercent(pct);
  overallBar.style.width = pct + "%";
}

function render(){
  updateOverall();
  toggleModeBtn.textContent = (state.mode === "teacher") ? "ูุนูู" : "ุทุงูุจ";

  if(state.route === "home"){
    renderHome();
  } else if(state.route.startsWith("module:")){
    const id = state.route.split(":")[1];
    const m = modules.find(x => x.id === id);
    if(!m){ state.route="home"; save(); return renderHome(); }
    renderModule(m);
  } else {
    state.route="home"; save(); renderHome();
  }

  // โ ุญูู ุฃู ุฃุฑูุงู ุธูุช ูู ุงููุตูุต ุฅูู ุนุฑุจูุฉ
  arabizeDigitsInTextNodes(document.getElementById("contentRoot"));
}

function renderHome(){
  const cards = modules.map(m => {
    const stats = moduleStats(m);
    return `
      <button class="card rounded-2xl bg-white p-5 text-right hover:bg-slate-50 transition"
              onclick="goModule('${m.id}')">
        <div class="flex items-start justify-between gap-4">
          <div>
            <div class="text-2xl font-extrabold">${m.icon} ${m.title}</div>
            <div class="muted mt-1">${m.goal}</div>
          </div>
          <div class="text-left">
            <div class="text-sm muted">ุฅุชูุงู</div>
            <div class="text-2xl font-extrabold">${toArabicDigits(stats.pct)}ูช</div>
          </div>
        </div>
        <div class="mt-4 h-2 rounded-full bg-slate-200 overflow-hidden">
          <div class="h-full bg-slate-900" style="width:${stats.pct}%"></div>
        </div>
      </button>
    `;
  }).join("");

  app.innerHTML = `
    <section class="grid lg:grid-cols-2 gap-4">
      <div class="card rounded-2xl bg-white p-6">
        <h2 class="text-xl font-extrabold">ุงุจุฏุฃ ุจุงูุทุฑููุฉ ุงูุตุญูุญุฉ</h2>
        <p class="muted mt-2 leading-8">
          ุงุฎุชุฑ ูุญุฏุฉุ ุซู ุญูู ุงูุฃุณุฆูุฉ ุจุงูุชุณูุณู.
          ุณุชุฃุฎุฐ <span class="hl font-bold">ุชุบุฐูุฉ ุฑุงุฌุนุฉ</span> ุจุนุฏ ูู ูุญุงููุฉ.
          ูู ูุถุน ุงููุนูู ุณุชุธูุฑ ุงูุญููู ูุงูุชูููุญุงุช ูุจุงุดุฑุฉ.
        </p>

        <div class="mt-4 grid md:grid-cols-2 gap-3">
          <div class="card rounded-2xl bg-amber-50 p-4">
            <div class="font-extrabold">๐จ ุชูุงุฑูู ูุญูููุฉ</div>
            <div class="muted text-sm mt-1">ุจููุณ ููุฑุฉ ุงููุชุงุจ ูุน ุชุธููู ุฃุตูุฑ.</div>
          </div>
          <div class="card rounded-2xl bg-slate-50 p-4">
            <div class="font-extrabold">๐ ุชุนุฒูุฒ ุงูููุงุฑุฉ</div>
            <div class="muted text-sm mt-1">ูู ุงูููุงุฑุฉ ุงูููููุฏุฉ ุฅูู ุงูููุชุณุจุฉ.</div>
          </div>
        </div>

        <div class="mt-4 card rounded-2xl bg-white p-4">
          <div class="font-extrabold">ูุตูุญุฉ ุณุฑูุนุฉ</div>
          <p class="muted mt-1 leading-7">
            ุฅุฐุง ูุงุฌูุช ุฎุทุฃ ูุชูุฑุฑ ูู ุงููุณูุฉ ุนูู 10: ุงุฑุฌุน ููุญูุงุฆู ุงููุชุฑุงุจุทุฉ ุฃูููุง ุซู ุนุฏ ููุชูุงุฑูู.
          </p>
        </div>
      </div>

      <div class="card rounded-2xl bg-white p-6">
        <h2 class="text-xl font-extrabold">ุงููุญุฏุงุช ุงููุชุงุญุฉ</h2>
        <div class="mt-4 grid gap-3">
          ${cards}
        </div>
      </div>
    </section>
  `;
}

function renderModule(m){
  const stats = moduleStats(m);
  const blocksHtml = m.blocks.map(b => renderBlock(b, m)).join("");

  app.innerHTML = `
    <section class="card rounded-2xl bg-white p-5 md:p-6">
      <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-4">
        <div>
          <div class="text-2xl font-extrabold">${m.icon} ${m.title}</div>
          <div class="muted mt-1">${m.goal}</div>
          <div class="mt-3 flex flex-wrap gap-2">
            <span class="pill px-3 py-1 rounded-full bg-slate-50 text-sm">
              ุฅุชูุงู ูุฐู ุงููุญุฏุฉ: <span class="font-extrabold">${toArabicDigits(stats.pct)}ูช</span>
            </span>
            <span class="pill px-3 py-1 rounded-full bg-amber-50 text-sm">
              ุฃุณุฆูุฉ ูููููุฉ: <span class="font-extrabold">${toArabicDigits(stats.total)}</span>
            </span>
          </div>
        </div>

        <div class="no-print card rounded-2xl bg-slate-50 p-4 min-w-[260px]">
          <div class="font-extrabold">ุชุบุฐูุฉ ุฑุงุฌุนุฉ ููููุงุฑุฉ</div>
          <ul class="mt-2 text-sm muted leading-7 list-disc pr-5">
            ${m.feedback.map(x => `<li>${x}</li>`).join("")}
          </ul>
        </div>
      </div>

      <hr class="my-5">

      <div class="print-area">
        ${blocksHtml}
      </div>

      <div class="no-print mt-6 flex flex-wrap gap-2">
        <button class="pill px-4 py-2 rounded-xl bg-slate-900 text-white hover:opacity-95" onclick="goHome()">โฌ๏ธ ุฑุฌูุน</button>
        <button class="pill px-4 py-2 rounded-xl bg-white hover:bg-slate-50" onclick="scrollToTop()">โฌ๏ธ ููุฃุนูู</button>
      </div>
    </section>
  `;
}

function renderBlock(b){
  if(b.type === "note"){
    return blockShell("๐ " + b.title, b.html, "bg-white");
  }
  if(b.type === "tip"){
    return blockShell("โ " + b.title, b.html, "bg-amber-50");
  }
  if(b.type === "solved"){
    const key = b.key || ("solved_" + Math.random());
    const btn = `
      <button class="no-print pill px-3 py-1.5 rounded-lg bg-white hover:bg-slate-50 text-sm font-bold"
              onclick="toggleSolved('${key}')">
        ${ showSolved(key) ? "ุฅุฎูุงุก ุงูุฎุทูุงุช" : "ุฅุธูุงุฑ ุงูุฎุทูุงุช" }
      </button>
    `;
    const body = `
      <div class="flex items-start justify-between gap-3">
        <div class="muted text-sm leading-7">
          ูุฐุง ูุซุงู ูุญููู. ูู ูุถุน ุงูุทุงูุจ ุงุณุชุฎุฏู ุฒุฑ โุฅุธูุงุฑ ุงูุฎุทูุงุชโ ุจุนุฏ ุงููุญุงููุฉ.
        </div>
        ${btn}
      </div>
      <div class="mt-3 ${showSolved(key) || state.mode==='teacher' ? "" : "hidden"}" id="sol_${key}">
        <ol class="list-decimal pr-5 leading-9">
          ${b.steps.map(s => `<li>${s}</li>`).join("")}
        </ol>
      </div>
    `;
    return blockShell("๐จ " + b.title, body, "bg-white");
  }
  if(b.type === "quiz"){
    const qHtml = b.questions.map(q => renderQuestion(q)).join("");
    return blockShell("๐งช " + b.title, `<div class="grid gap-3">${qHtml}</div>`, "bg-white");
  }
  if(b.type === "open"){
    const body = `
      <ul class="list-disc pr-5 leading-8">
        ${b.prompts.map(p => `<li>${p}</li>`).join("")}
      </ul>
      <div class="mt-3 card rounded-2xl bg-slate-50 p-4">
        <div class="font-extrabold">ุชูุฌูู (ููุงุฑุงุช ุนููุง)</div>
        <p class="muted mt-1 leading-7">
          ุงูุชุจ ููุฑุชู ุซู ูุฏูู ูุซุงููุง. ุฅุฐุง ููุช ูุนูููุงุ ุงุทูุจ ูู ุงูุทุงูุจ ุชุจุฑูุฑ ุงูุฅุฌุงุจุฉ ูููุณ ูุชุงุจุฉ ุงููุงุชุฌ ููุท.
        </p>
      </div>
    `;
    return blockShell("๐ง " + b.title, body, "bg-white");
  }
  if(b.type === "generator"){
    const key = b.key;
    const stored = state.dynamicQuestions[key] || [];
    const fields = b.fields.map(f => renderField(key, f)).join("");

    const generatedHtml = stored.length ? `
      <div class="mt-4">
        <div class="font-extrabold">ุงูุฃุณุฆูุฉ ุงูููููุฏุฉ</div>
        <div class="mt-2 grid gap-3">
          ${stored.map(q => renderQuestion(q)).join("")}
        </div>
      </div>
    ` : `<div class="mt-4 muted text-sm">ูู ุชูููุฏ ุฃุณุฆูุฉ ุจุนุฏ โ ุงุฎุชุฑ ุงูุฅุนุฏุงุฏุงุช ุซู ุงุถุบุท โุชูููุฏโ.</div>`;

    const body = `
      <div class="muted text-sm leading-7">ุงุณุชุฎุฏู ูุฐุง ุงููุณู ูุฅุถุงูุฉ ุชุฏุฑูุจ ูุชุฃููุฏ ุฌุฏูุฏูู ุจุนุฏ ุฅุชูุงู ุงูุฃุณุงุณูุงุช.</div>
      <div class="mt-3 grid md:grid-cols-2 gap-3 no-print">
        ${fields}
      </div>
      <div class="mt-3 no-print flex flex-wrap gap-2">
        <button class="pill px-4 py-2 rounded-xl bg-slate-900 text-white hover:opacity-95" onclick="runGenerator('${key}')">โก๏ธ ุชูููุฏ</button>
        <button class="pill px-4 py-2 rounded-xl bg-white hover:bg-slate-50" onclick="clearGenerator('${key}')">๐งน ูุณุญ ุงูููููุฏ</button>
      </div>
      ${generatedHtml}
    `;

    window.__generators = window.__generators || {};
    window.__generators[key] = b.onGenerate;

    return blockShell("โ " + b.title, body, "bg-white");
  }
  return "";
}

function blockShell(title, innerHtml, bgClass){
  return `
    <section class="card rounded-2xl ${bgClass} p-5 mb-4 break-inside-avoid">
      <h3 class="text-lg font-extrabold">${title}</h3>
      <div class="mt-3 leading-8">${innerHtml}</div>
    </section>
  `;
}

function renderQuestion(q){
  const p = getProgress(q.id);
  const attempted = p.attempted;
  const correct = p.correct;

  const badge = attempted
    ? (correct
        ? `<span class="pill px-2 py-1 rounded-full bg-emerald-50 text-emerald-800 text-xs font-bold">ุตุญูุญ โ</span>`
        : `<span class="pill px-2 py-1 rounded-full bg-rose-50 text-rose-800 text-xs font-bold">ุบูุฑ ุตุญูุญ โ</span>`)
    : `<span class="pill px-2 py-1 rounded-full bg-slate-50 text-slate-700 text-xs font-bold">ูู ุชูุญุงูู ุจุนุฏ</span>`;

  const hint = (state.mode === "teacher" || attempted) && q.hint
    ? `<div class="mt-2 text-sm muted">๐ก ${q.hint}</div>`
    : "";

  const answerReveal = (state.mode === "teacher")
    ? renderAnswer(q)
    : (attempted ? renderAnswer(q, true) : "");

  let inputArea = "";
  if(q.type === "input"){
    inputArea = `
      <div class="no-print mt-3 flex flex-col md:flex-row md:items-center gap-2">
        <input id="in_${q.id}"
               class="w-full md:w-64 pill rounded-xl px-3 py-2 bg-white"
               placeholder="ุงูุชุจ ุงูุฅุฌุงุจุฉ ููุง" inputmode="numeric"
               oninput="this.value = toArabicDigits(toWesternDigits(this.value))" />
        <button class="pill px-4 py-2 rounded-xl bg-slate-900 text-white hover:opacity-95"
                onclick="checkInput('${q.id}', '${escapeHtml(q.answer)}')">ุชุญูู</button>
      </div>
      <div class="print-show-blank"></div>
    `;
  } else if(q.type === "mcq"){
    inputArea = `
      <div class="no-print mt-3 grid gap-2">
        ${q.choices.map((c, idx) => `
          <label class="pill rounded-xl px-3 py-2 bg-white hover:bg-slate-50 cursor-pointer flex items-center gap-2">
            <input type="radio" name="mcq_${q.id}" value="${idx}" class="w-4 h-4" />
            <span>${c}</span>
          </label>
        `).join("")}
        <button class="pill px-4 py-2 rounded-xl bg-slate-900 text-white hover:opacity-95"
                onclick="checkMCQ('${q.id}', ${q.correctIndex})">ุชุญูู</button>
      </div>
    `;
  } else if(q.type === "tf"){
    inputArea = `
      <div class="no-print mt-3 flex flex-wrap gap-2">
        <button class="pill px-4 py-2 rounded-xl bg-white hover:bg-slate-50"
                onclick="checkTF('${q.id}', true, ${q.correctBool})">ุตุญ</button>
        <button class="pill px-4 py-2 rounded-xl bg-white hover:bg-slate-50"
                onclick="checkTF('${q.id}', false, ${q.correctBool})">ุฎุทุฃ</button>
      </div>
    `;
  }

  return `
    <div class="card rounded-2xl bg-white p-4 break-inside-avoid">
      <div class="flex items-start justify-between gap-3">
        <div class="text-base font-bold leading-8">${q.promptHtml}</div>
        <div class="shrink-0">${badge}</div>
      </div>
      ${inputArea}
      ${hint}
      ${answerReveal}
      <div id="msg_${q.id}" class="mt-2 text-sm"></div>
    </div>
  `;
}

function renderAnswer(q, forStudent=false){
  if(q.type === "input"){
    return `<div class="mt-2 text-sm ${forStudent ? 'muted' : ''}">โ ุงูุฅุฌุงุจุฉ: <span class="hl font-bold">${q.answer}</span></div>`;
  }
  if(q.type === "mcq"){
    const correct = q.choices[q.correctIndex];
    return `<div class="mt-2 text-sm ${forStudent ? 'muted' : ''}">โ ุงูุฅุฌุงุจุฉ: <span class="hl font-bold">${correct}</span></div>`;
  }
  if(q.type === "tf"){
    return `<div class="mt-2 text-sm ${forStudent ? 'muted' : ''}">โ ุงูุฅุฌุงุจุฉ: <span class="hl font-bold">${q.correctBool ? "ุตุญ" : "ุฎุทุฃ"}</span></div>`;
  }
  return "";
}

function moduleStats(m){
  const ids = [];
  for(const b of m.blocks){
    if(b.type === "quiz"){
      for(const q of b.questions) ids.push(q.id);
    }
    if(b.type === "generator"){
      const key = b.key;
      const stored = state.dynamicQuestions[key] || [];
      for(const q of stored) ids.push(q.id);
    }
  }
  const attempted = ids.filter(id => getProgress(id).attempted);
  if(attempted.length === 0) return { pct: 0, total: 0, correct: 0 };
  const correct = attempted.filter(id => getProgress(id).correct).length;
  const pct = Math.round((correct / attempted.length) * 100);
  return { pct, total: attempted.length, correct };
}

/* =========================
   Solved Toggle
========================= */
function showSolved(key){
  state.dynamicQuestions.__solved = state.dynamicQuestions.__solved || {};
  return !!state.dynamicQuestions.__solved[key];
}
window.toggleSolved = function(key){
  state.dynamicQuestions.__solved = state.dynamicQuestions.__solved || {};
  state.dynamicQuestions.__solved[key] = !state.dynamicQuestions.__solved[key];
  save();
  render();
};

/* =========================
   Checkers
========================= */
window.checkInput = function(qid, expected){
  const el = document.getElementById("in_" + qid);
  const msg = document.getElementById("msg_" + qid);
  const user = normalizeAnswer(el?.value);
  const ok = user !== "" && user === normalizeAnswer(expected);
  setProgress(qid, ok);

  if(ok){
    msg.className = "mt-2 text-sm text-emerald-700 font-bold";
    msg.textContent = "ุฃุญุณูุช โ ุฅุฌุงุจุฉ ุตุญูุญุฉ.";
  } else {
    msg.className = "mt-2 text-sm text-rose-700 font-bold";
    msg.textContent = "ุฌุฑูุจ ูุฑุฉ ุฃุฎุฑู โ ูุชุฐููุฑ ุงููุงุนุฏุฉ ุงููุธููุฉ.";
    el.classList.add("shake");
    setTimeout(() => el.classList.remove("shake"), 250);
  }
  render();
};

window.checkMCQ = function(qid, correctIndex){
  const msg = document.getElementById("msg_" + qid);
  const radios = document.querySelectorAll(`input[name="mcq_${qid}"]`);
  let chosen = null;
  radios.forEach(r => { if(r.checked) chosen = Number(r.value); });

  if(chosen === null){
    msg.className = "mt-2 text-sm text-rose-700 font-bold";
    msg.textContent = "ุงุฎุชุฑ ุฅุฌุงุจุฉ ุฃูููุง ุซู ุงุถุบุท ุชุญูู.";
    return;
  }

  const ok = (chosen === correctIndex);
  setProgress(qid, ok);

  if(ok){
    msg.className = "mt-2 text-sm text-emerald-700 font-bold";
    msg.textContent = "ุฃุญุณูุช โ ุงุฎุชูุงุฑ ุตุญูุญ.";
  } else {
    msg.className = "mt-2 text-sm text-rose-700 font-bold";
    msg.textContent = "ุบูุฑ ุตุญูุญ โ ุฑุงุฌุน ุงูุชูููุญ ุซู ุฃุนุฏ ุงููุญุงููุฉ.";
  }
  render();
};

window.checkTF = function(qid, chosenBool, correctBool){
  const msg = document.getElementById("msg_" + qid);
  const ok = (chosenBool === correctBool);
  setProgress(qid, ok);

  if(ok){
    msg.className = "mt-2 text-sm text-emerald-700 font-bold";
    msg.textContent = "ุฃุญุณูุช โ.";
  } else {
    msg.className = "mt-2 text-sm text-rose-700 font-bold";
    msg.textContent = "ุบูุฑ ุตุญูุญ โ ุฑุงุฌุน ุงููุงุนุฏุฉ ุงููุธููุฉ.";
  }
  render();
};

/* =========================
   Navigation
========================= */
window.goModule = function(id){
  state.route = "module:" + id;
  save();
  render();
};
window.goHome = function(){
  state.route = "home";
  save();
  render();
};
window.scrollToTop = function(){
  window.scrollTo({ top: 0, behavior: "smooth" });
};

/* =========================
   Generator UI
========================= */
function fieldId(key, fkey){ return `gen_${key}_${fkey}`; }

function renderField(key, f){
  const id = fieldId(key, f.key);

  if(f.type === "select"){
    return `
      <label class="card rounded-2xl bg-white p-4">
        <div class="text-sm muted">${f.label}</div>
        <select id="${id}" class="mt-2 w-full pill rounded-xl px-3 py-2 bg-white">
          ${f.options.map(o => `<option value="${o}">${o}</option>`).join("")}
        </select>
      </label>
    `;
  }

  // โ ูุฌุนููุง text ูุชูุจู ุงูุฃุฑูุงู ุงูุนุฑุจูุฉ ูุชุนุฑุถูุง ุนุฑุจูุฉ
  if(f.type === "number"){
    return `
      <label class="card rounded-2xl bg-white p-4">
        <div class="text-sm muted">${f.label}</div>
        <input id="${id}" type="text" inputmode="numeric"
               data-min="${f.min}" data-max="${f.max}"
               value="${f.value ?? f.min}"
               oninput="this.value = toArabicDigits(toWesternDigits(this.value))"
               class="mt-2 w-full pill rounded-xl px-3 py-2 bg-white"/>
        <div class="text-xs muted mt-1">ูู ${f.min} ุฅูู ${f.max}</div>
      </label>
    `;
  }

  return "";
}

window.runGenerator = function(key){
  const genFn = (window.__generators || {})[key];
  if(!genFn) return;

  const cfg = {};
  const mod = modules.find(m => m.blocks.some(b => b.type === "generator" && b.key === key));
  const block = mod?.blocks.find(b => b.type === "generator" && b.key === key);

  (block?.fields || []).forEach(f => {
    const el = document.getElementById(fieldId(key, f.key));
    if(!el){ cfg[f.key] = null; return; }

    if(f.type === "number"){
      const min = Number(el.dataset.min || f.min || 1);
      const max = Number(el.dataset.max || f.max || 99);
      let v = parseInt(toWesternDigits(el.value), 10);
      if(!Number.isFinite(v)) v = f.value ?? min;
      v = Math.max(min, Math.min(max, v));
      cfg[f.key] = v;
      // ุฃุนุฏ ุนุฑุถ ุงููููุฉ ุนุฑุจูุฉ ุจุนุฏ ุงูุถุจุท
      el.value = toArabicDigits(v);
    } else {
      cfg[f.key] = el.value;
    }
  });

  const qs = genFn(cfg) || [];
  state.dynamicQuestions[key] = qs;
  save();
  render();
};

window.clearGenerator = function(key){
  state.dynamicQuestions[key] = [];
  save();
  render();
};

/* =========================
   UI Buttons
========================= */
btnHome.addEventListener("click", () => goHome());

toggleModeBtn.addEventListener("click", () => {
  state.mode = (state.mode === "teacher") ? "student" : "teacher";
  save();
  render();
});

btnReset.addEventListener("click", () => {
  if(confirm("ูู ุชุฑูุฏ ุชุตููุฑ ุงูุชูุฏููุ")){
    state.progress = {};
    save();
    render();
  }
});

btnPrintStudent.addEventListener("click", () => {
  const prev = state.mode;
  state.mode = "student";
  save();
  render();
  setTimeout(() => {
    window.print();
    state.mode = prev;
    save();
    render();
  }, 250);
});

btnPrintTeacher.addEventListener("click", () => {
  const prev = state.mode;
  state.mode = "teacher";
  save();
  render();
  setTimeout(() => {
    window.print();
    state.mode = prev;
    save();
    render();
  }, 250);
});

/* =========================
   Utils
========================= */
function escapeHtml(str){
  return String(str).replace(/[&<>"']/g, (m) => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[m]));
}

/* =========================
   Init
========================= */
load();
render();
</script>

</body>
</html>
